name: Frontend CD (Kubernetes)

on:
    push:
        tags:
            - "v*.*.*"

jobs:
    deploy-frontend:
        runs-on: self-hosted

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set kubeconfig
              run: |
                  mkdir -p ~/.kube
                  echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
                  chmod 600 ~/.kube/config

            - name: Set frontend image version
              run: |
                  kubectl set image deployment/frontenfrontend-deploymentd \
                    frontend=ghcr.io/luisrodvilladaorg/wellness-ops-frontend:${GITHUB_REF_NAME}

            - name: Wait for rollout
              run: |
                  kubectl rollout status deployment/frontend --timeout=120s

            - name: Verify frontend availability
              run: |
                  curl -k https://wellness.local
