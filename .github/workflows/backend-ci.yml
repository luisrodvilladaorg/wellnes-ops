name: Backend CI (Docker + Tests)

on:
    push:
        branches:
            - feature-test-backend
            - main
            - master
    pull_request:

jobs:
    test-backend:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker
              uses: docker/setup-buildx-action@v3

            - name: Build and start production stack
              run: |
                  docker compose -f docker-compose.prod.yml up -d --build

            - name: Wait for backend to be ready
              run: |
                  echo "Waiting for backend..."
                  for i in {1..15}; do
                    if curl -s http://localhost/api/health | grep OK; then
                      echo "Backend is up"
                      exit 0
                    fi
                    sleep 2
                  done
                  echo "Backend did not start in time"
                  docker compose -f docker-compose.prod.yml logs
                  exit 1

            - name: Run backend tests inside container
              run: |
                  docker exec wellness-backend-prod npm test

            - name: Show logs on failure
              if: failure()
              run: |
                  docker compose -f docker-compose.prod.yml logs
