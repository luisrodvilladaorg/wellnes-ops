name: Backend CI

on:
    push:
        branches:
            - feature-proof-CI/CD
    pull_request:

jobs:
    backend-ci:
        runs-on: ubuntu-latest

        steps:
            # 1️⃣ Clonamos el repositorio
            - name: Checkout repository
              uses: actions/checkout@v4

            # 2️⃣ Validamos que el backend tiene la estructura mínima
            - name: Validate backend structure
              run: |
                  test -f backend/Dockerfile.prod
                  test -f backend/package.json
                  test -f backend/src/app.js
                  test -d backend/src/routes
                  test -d backend/src/middleware

            # 3️⃣ Instalamos Node.js (versión estable)
            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 18

            # 4️⃣ Instalamos dependencias del backend
            - name: Install backend dependencies
              working-directory: backend
              run: npm ci

            # 5️⃣ Levantamos el backend antes de correr los tests
            - name: Start backend
              working-directory: backend
              run: |
                  npm start &
                  sleep 3

            # 6️⃣ Ejecutamos tests si existen
            - name: Run backend tests (optional)
              working-directory: backend
              run: |
                  if [ -f package.json ] && grep -q "\"test\":" package.json; then
                    npm test
                  else
                    echo "No tests defined, skipping"
                  fi

            # 7️⃣ Construimos la imagen Docker del backend (solo build)
            - name: Build backend Docker image
              run: |
                  docker build \
                    -f backend/Dockerfile.prod \
                    -t backend-ci:test \
                    backend
