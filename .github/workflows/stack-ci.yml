name: Stack CI (docker-compose validation)

on:
  push:
    branches: [main]
  pull_request:

jobs:
  stack-ci:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check docker-compose.prod.yml exists
        run: test -f docker-compose.prod.yml

      - name: Create prod env file
        run: |
          mkdir -p env/prod
          cat <<EOF > env/prod/.env
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}

          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          JWT_SECRET=${{ secrets.JWT_SECRET }}
          NODE_ENV=${{ secrets.NODE_ENV }}
          PORT=${{ secrets.PORT }}
          EOF

      - name: Validate docker-compose syntax
        run: docker compose -f docker-compose.prod.yml config

      - name: Validate Dockerfiles used by compose
        run: |
          test -f backend/Dockerfile.prod
          test -f frontend/Dockerfile.prod
          test -f nginx/Dockerfile.prod

      - name: Build stack images
        run: docker compose -f docker-compose.prod.yml build

      - name: Docker cleanup
        if: always()
        run: |
          docker system prune -af || true
