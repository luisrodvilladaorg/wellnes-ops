name: Nginx CD - Local deploy

on:
    push:
        branches:
            - main # Solo desplegamos cuando se hace push a main

jobs:
    deploy-nginx:
        # üîë IMPORTANTE: usamos el runner local
        runs-on: self-hosted

        steps:
            # 1Ô∏è‚É£ Informaci√≥n b√°sica (debug / claridad)
            - name: Show runner info
              run: |
                  echo "Running on:"
                  hostname
                  whoami
                  pwd

            # 2Ô∏è‚É£ Ir al directorio del proyecto en el servidor
            - name: Go to project directory
              run: |
                  cd /opt/wellness-ops

            # 3Ô∏è‚É£ Descargar la √∫ltima imagen desde GHCR
            # Esto asegura que usamos la imagen generada por CI
            - name: Pull latest nginx image
              run: |
                  cd /opt/wellness-ops
                  docker compose pull nginx

            # 4Ô∏è‚É£ Recrear SOLO el contenedor nginx
            # --no-deps evita tocar backend, db, etc.
            - name: Restart nginx container
              run: |
                  cd /opt/wellness-ops
                  docker compose up -d --no-deps nginx

            # 5Ô∏è‚É£ Comprobaci√≥n r√°pida
            - name: Check nginx container status
              run: |
                  docker ps | grep nginx
