name: Stack DOWN (Production)

# ‚ùó Este workflow NO se ejecuta con push
# ‚ùó Solo manual desde GitHub Actions
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type DOWN to confirm stack shutdown"
        required: true
        default: ""

jobs:
  shutdown:
    name: Stop production stack
    runs-on: self-hosted
    environment: production

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DOWN" ]; then
            echo "‚ùå Confirmation failed. Type DOWN to proceed."
            exit 1
          fi

      - name: Show runner info
        run: |
          hostname
          whoami
          pwd

      - name: Ensure clean repo state
        run: |
          cd /opt/wellnes-ops
          git fetch origin main
          git reset --hard origin/main

      - name: Stop Docker Compose stack
        run: |
          cd /opt/wellnes-ops
          docker compose -f docker-compose.prod.yml down --remove-orphans || true

      - name: Show running containers
        run: docker ps

      - name: Execution proof
        run: |
          echo "üß® STACK STOPPED"
          date

      - name: Ensure clean repo state
        run: |
          cd /opt/wellnes-ops
          git fetch origin main --prune
          git reset --hard origin/main
